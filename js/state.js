import initForm from"./form.js";import{myMap}from"./map.js";import{replaceTextContentNumber,calculate}from"./utils.js";const FAVORITES_NUMBER=8,PROMOTION="- 4 000",RIGHT_PROMOCODE="5uglov",PROMOCODE_SALE="- 500",form=document.querySelector(".order-form"),wareCards=form.getElementsByClassName("ware-card"),favoritesLabel=document.querySelector(".js-favorites-count"),cartLabel=document.querySelector(".js-cart-count"),totalBillSum=form.querySelector(".js-bill-total"),totalWaresCount=form.querySelector(".js-total-ware-count"),totalWaresSums=form.querySelectorAll(".js-total-ware-sum"),billSaleSum=form.querySelector(".js-bill-sale-sum"),promocodeValue=form.querySelector(".js-promocode-value"),allWaresCountInput=form.querySelector("input[data-input=all-wares-count]"),allWaresSumInput=form.querySelector("input[data-input=all-wares-sum]"),promotionInput=form.querySelector("input[data-input=promotion]"),promocodeInput=form.querySelector("input[data-input=promocode]"),allPromotionSumInput=form.querySelector("input[data-input=all-promotion]"),totalBillSumInput=form.querySelector("input[data-input=total-bill]"),updateState=()=>{totalWaresCount.textContent=calculate("count",form,"count-selection__count"),totalWaresSums.forEach((e=>e.textContent=calculate("sum",form,"js-ware-total-price"))),totalBillSum.textContent=calculate("sum",form,"js-bill-sum"),favoritesLabel.dataset.count=8,cartLabel.dataset.count=parseInt(totalWaresCount.textContent);for(const e of wareCards){e.querySelector("input[data-input=price]").value=e.querySelector(".js-ware-price")?.textContent;e.querySelector("input[data-input=count]").value=e.querySelector(".count-selection__count")?.textContent;e.querySelector("input[data-input=sum]").value=e.querySelector(".js-ware-total-price")?.textContent}allWaresCountInput.value=parseInt(totalWaresCount.textContent),allWaresSumInput.value=totalWaresSums[0].textContent,promotionInput.value="- 4 000",promocodeInput.value=form.querySelector(".js-promocode-value").textContent,allPromotionSumInput.value=form.querySelector(".js-bill-sale-sum").textContent,totalBillSumInput.value=totalBillSum.textContent},activateInput=e=>{const t=e.parentElement;e.addEventListener("focus",(()=>{!t.classList.contains("js-active-input")&&t.classList.add("js-active-input")})),e.addEventListener("blur",(()=>{!e.value&&t.classList.remove("js-active-input")}))},deactivateInput=e=>{e.parentElement.classList.remove("js-active-input")},changeQuantity=e=>{const{target:t}=e,a=t.parentElement,r=e.currentTarget.parentElement,n=r.querySelector(".js-ware-old-price")?replaceTextContentNumber(r.querySelector(".js-ware-old-price")):null,o=r.querySelector(".js-ware-total-old-price"),l=replaceTextContentNumber(r.querySelector(".js-ware-price")),u=r.querySelector(".js-ware-total-price"),[s,c,i]=Array.from(a.children);t===i?c.textContent=+c.textContent+1:t===s&&+c.textContent>1&&(c.textContent=+c.textContent-1),u.textContent=(+c.textContent*l).toLocaleString(),updateState(),n&&(o.textContent=(+c.textContent*n).toLocaleString()),1==+c.textContent?s.disabled=!0:s.disabled=!1},removeWare=e=>{const t=e.target.parentElement,a=t.innerHTML,r=t.querySelector(".js-ware-name").textContent,n=t.querySelector(".js-ware-article").textContent,o=`\n          <div class="ware-card__delete-item-template">\n            <h3 class="visually-hidden">Удаленный товар</h3>\n            <span class="ware-card__delete-item-annotation">Товар <span\n                class="ware-card__delete-item-name js-delete-item-name">${r}</span> был удален из\n              корзины.</span>\n            <a class="ware-card__delete-item-recover-link js-ware-recover-link" href="#">Восстановить</a>\n            <button class="ware-card__delete-button js-delete-button" type="button">\n              <span class="visually-hidden">Убрать товар</span>\n            </button>\n          </div>\n          <input data-input="price" type="hidden" name="${n}-price" value="">\n          <input data-input="count" type="hidden" name="${n}-count" value="">\n          <input data-input="sum" type="hidden" name="${n}-sum" value="">`;t.classList.add("js-delete-ware"),t.innerHTML=o,updateState(),t.querySelector(".js-delete-button").addEventListener("click",(()=>{t.parentElement.remove()})),t.querySelector(".js-ware-recover-link").addEventListener("click",(e=>{e.preventDefault(),t.classList.remove("js-delete-ware"),t.innerHTML=a,initForm()}))},applyPromocode=e=>{const{target:t}=e,a=document.createElement("span"),r=e.currentTarget.firstChild,n=r.nextElementSibling,o=e.currentTarget.lastChild;t===n&&e.preventDefault(),t===n&&r.value&&("5uglov"===r.value.toLowerCase()?(a.className="promocode__result-message--success",a.textContent=`${r.value} - купон применен`,o.replaceWith(a),promocodeValue.textContent="- 500",billSaleSum.textContent=calculate("sum",form,"js-bill-sale"),totalBillSum.textContent=calculate("sum",form,"js-bill-sum")):(a.className="promocode__result-message--error",a.textContent=`${r.value} - купон не найден`,o.replaceWith(a)),r.value="",deactivateInput(r)),updateState()},activateAdressSearchButton=()=>{form.querySelector(".form-contacts__sarch-button").addEventListener("click",(e=>{const t=e.target.previousElementSibling;myMap.setCenter([t.dataset.x,t.dataset.y],15,{duration:300,timingFunction:"ease-in"}),myMap.geoObjects.get(0).geometry.setCoordinates([t.dataset.x,t.dataset.y])}))};export{activateInput,deactivateInput,removeWare,changeQuantity,updateState,applyPromocode,activateAdressSearchButton};